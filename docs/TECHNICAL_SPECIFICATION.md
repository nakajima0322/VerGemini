# KHT バーコードスキャンシステム 技術仕様書

**Version: 2.0**
**Last Updated: 2025-11-26**

## 1. プロジェクト概要

本システムは、工場や倉庫における部品管理業務を効率化するための、PCカメラを利用したバーコードスキャンアプリケーション群である。主な目的は、バーコードをスキャンして「いつ」「どこで」「何を」スキャンしたかを記録し、そのデータを基に発注情報との照合や、部品情報の検索を容易にすることである。

システムは複数の独立したPythonスクリプト（GUIツール）で構成されており、`G_Launcher.py` を介して各機能にアクセスする。設定は `config.json` ファイルで一元管理される。

## 2. システムアーキテクチャ

### 2.1. 基本ワークフロー

#### 2.1.1. 保管場所登録フロー

1. **起動:** `G_Launcher.py` を起動し、作業者を選択する。
2. **ツール選択:** 「保管場所登録スキャン」ボタンをクリックし、`G_ScanBCD_main.py` を起動する。
3. **場所と工事番号の選択:** `G_ScanBCD_Location.py` の画面で、作業場所と対象の工事番号を選択する。
4. **スキャン開始:** `G_ScanBCD_Scanner.py` がカメラを起動し、スキャン画面が表示される。
5. **データ記録:** スキャンされたバーコードは、ヘッダー付きの `data/{工事番号}.csv` にUTF-8で追記される。
6. **手動登録:** スキャン画面から `G_ManualEntryDialog.py` を呼び出し、発注伝票CSVを検索して手動でデータを登録できる。
7. **終了と後処理:** スキャン終了後、`G_ScanBCD_FixCSV.py` が重複データをチェックし、`G_DrawingNumberViewer.py` などの後続ツールを任意で起動できる。

#### 2.1.2. 工程登録フロー

1. **起動:** `G_Launcher.py` を起動し、作業者を選択する。
2. **ツール選択:** 「工程登録スキャン」ボタンをクリックし、`G_ProcessSorter.py` を起動する。
3. **工程情報の選択:** 工事番号、納品業者、追加工程を選択する。
4. **スキャン開始:** `G_ProcessScanner.py` がカメラを起動し、スキャン画面が表示される。
5. **データ記録:** スキャンされたバーコードは、ヘッダー付きの `data/{工事番号}_processed.csv` にUTF-8で追記される。

### 2.2. データフローとエンコード仕様

- **入力データ:**
  - **保管場所スキャンデータ (`data/{工事番号}.csv`):** `G_ScanBCD_main.py` が生成する。`worker_name` 列を含むヘッダー付きCSV。
  - **工程スキャンデータ (`data/{工事番号}_processed.csv`):** `G_ProcessSorter.py` が生成する。`worker_name` 列を含むヘッダー付きCSV。
  - **発注伝票データ (`Source/{工事番号}s.csv`):** 部品情報が記載されたマスターデータ。外部で用意される。
- **出力データ:**
  - **結合データ (`data/{工事番号}result.csv`):** `create_combined_csv.py` がスキャンデータと発注伝票データを結合して生成する、ヘッダー付きのCSVファイル。
- **エンコード:**
  - **本システムの入出力CSVファイルは、すべて `UTF-8` で統一されている。** 発注伝票CSVのみ、BOM付きUTF-8 (`utf-8-sig`) にも対応している。
- **旧形式データへの対応:**
  - `G_ScanBCD_FixCSV.py` は、`worker_name` 列のない古い形式のCSVファイルを自動で検出し、読み込み時にメモリ上で新形式に変換する。保存時には必ず新形式で書き出すため、一度処理を通すことでデータ形式が統一される。

## 2.3. ワークフローフローチャート

```mermaid
graph TD
    subgraph ランチャー
        A[G_Launcher.py 起動] --> B[作業者を選択];
    end

    subgraph 保管場所登録
        B --> C1[保管場所登録スキャン];
        C1 --> D1[G_ScanBCD_main.py 実行];
        D1 --> E1[場所/工事番号を選択];
        E1 --> F1[G_ScanBCD_Scanner.py 起動];
        F1 --> G1[スキャン & data/{cn}.csv へ記録];
    end

    subgraph 工程登録
        B --> C2[工程登録スキャン];
        C2 --> D2[G_ProcessSorter.py 実行];
        D2 --> E2[工程/業者/工事番号を選択];
        E2 --> F2[G_ProcessScanner.py 起動];
        F2 --> G2[スキャン & data/{cn}_processed.csv へ記録];
    end

    subgraph データ加工・照合
        B --> C3[データ修正ツール];
        C3 --> D3[G_ScanBCD_FixCSV.py 実行];
        D3 --> E3[重複削除/ヘッダー修正];

        B --> C4[結合CSV作成];
        C4 --> D4[create_combined_csv.py 実行];
        D4 --> E4[スキャンデータと発注データを結合];
        E4 --> F4[data/{cn}result.csv を生成];

        B --> C5[保管場所照合ツール];
        C5 --> D5[G_DrawingNumberViewer.py 実行];
        D5 --> E5[スキャンデータと発注データを照合];
    end
```

## 3. コンポーネント（ファイル）解説

### 3.1. ランチャー

- **`G_Launcher.py`**
  - **役割:** 全てのツールへの入り口となるGUIランチャー。
  - **単独起動:** 可能 (`python G_Launcher.py`)。

### 3.2. メインスキャン関連

- **`G_ScanBCD_main.py`**: メインワークフローの制御役。単独起動可能。
- **`G_ScanBCD_Scanner.py`**: カメラ制御とバーコードスキャンのコアエンジン。
- **`G_ScanBCD_Location.py`**: 起動時の場所・工事番号選択GUI。
- **`G_ScanBCD_CsvWriter.py`**: スキャンデータをCSVに追記する。
- **`G_ScanBCD_DataCollector.py`**: スキャン情報を辞書形式に整形する。
- **`G_ScanBCD_Overlay.py`**: カメラ映像に情報をリアルタイム描画する。
- **`G_ScanBCD_Results.py`**: スキャン完了後の結果概要ダイアログ。
- **`G_ManualEntryDialog.py`**: 手動登録用モーダルダイアログ。単体でのテスト起動も可能。

### 3.3. データ加工・照合・管理ツール

- **`G_ScanBCD_FixCSV.py`**: スキャンデータCSVの重複・不正データを修正する。単独起動可能。
- **`G_DrawingNumberViewer.py`**: スキャンデータと発注伝票データを照合・監査するツール。単独起動可能。
- **`G_PartInfoViewer.py`**: バーコードをキーに部品情報を検索する高機能ツール。カメラ機能、同一図番検索機能も内蔵。単独起動可能。
- **`create_combined_csv.py`**: スキャンデータと発注データをマージし、最終的なレポートCSVを生成する。単独起動可能。
- **`G_WorkflowManager.py`**: 工事番号ごとのファイル（スキャンデータ、マスター、レポート）の有無を確認し、各処理（スキャン、結合）を起動するための管理ツール。単独起動可能。

### 3.4. 設定・共通モジュール

- **`config.json`**: システム全体の設定ファイル。カメラ設定、バーコード仕様、CSV列名などを定義。
- **`G_config.py`**: `config.json` の読み書きを抽象化するクラス。
- **`G_ConfigEditor.py`**: `config.json` をGUIで編集するためのツール。単独起動可能。
- **`G_ScanBCD_Analyzer.py`**: `pyzbar` を用いて画像からバーコードを解析する。

## 4. コードレビューに基づく改善提案

(既存の `Code_Review_Summary.md` の内容を統合・反映)

- **🔴 仕様確認済:** `G_ScanBCD_FixCSV.py` のバーコード英字チェックは、「数字のみ」という運用ルールに基づく意図した仕様である。（現在は `G_ScanBCD_Scanner.py` 内で `expected_length` と `barcode_type` のみチェック）

- **🟡 中優先度（安定性）:**
  - **「バーコードなし物品」IDの一意性:** `G_ScanBCD_Scanner.py` のID生成ロジックは、セッションをまたいだ一意性が保証されない。最後に使用した番号をファイルに保存・読み込みするなどの改善を推奨。
  - **描画の二重実行:** `G_ScanBCD_Analyzer.py` と `G_ScanBCD_Overlay.py` でバーコードの矩形が二重に描画されている。描画処理は `G_ScanBCD_Overlay.py` に一元化すべき。

- **🟢 低優先度（パフォーマンス・UI）:**
  - **重複チェックの効率:** `G_ScanBCD_Scanner.py` 内でスキャン済みバーコードを記録する `list` を `set` に変更することで、パフォーマンス向上が見込める。
  - **ウィンドウ位置の固定:** `G_ScanBCD_Scanner.py` でスキャナウィンドウの位置が固定値で計算されている。`tkinter`で画面サイズを動的に取得する方式に変更すれば、異なる解像度のPCでも安定して表示できる。
  - **エンコードのハードコード:** 各所に `encoding='utf-8'` が直接記述されている。将来的にエンコードを変更する可能性に備え、`G_config.py` から設定値を読み込むように統一することも考えられる。（ただし、現行はUTF-8統一仕様）

## 5. 運用前点検チェックリスト

(既存の `Code_Review_Summary.md` の内容を統合・反映)

1. **【最重要】運用ルールの再確認:** バーコードは「数字のみ」というルールを関係者全員で再確認する。
2. **`config.json` の再確認:** `barcode_type`, `expected_length`, 各種CSV列名が、使用する実データと完全に一致しているかを確認する。
3. **実行環境の準備:** `opencv-python`, `pyzbar`, `numpy` がインストールされているか確認する。
4. **一連の操作テスト:**
    1. `G_DrawingNumberViewer.py` でマスターCSV（発注伝票）を一度開き、設定を保存する。
    2. `G_ScanBCD_main.py` を起動し、場所と工事番号を選択。
    3. バーコードのスキャン、重複スキャン、手動登録(`m`キー)、バーコードなし登録(`n`キー) を試す。
    4. `data` フォルダ内に正しい内容のCSVが `UTF-8` で生成されているか確認する。
5. **照合・監査ツールのテスト:** `G_DrawingNumberViewer.py` で「照合実行」を行い、結果が意図通りか確認する。
6. **CSV修正ツールのテスト:** `G_ScanBCD_FixCSV.py` を単独起動し、生成されたCSVの重複削除が機能するかテストする。
