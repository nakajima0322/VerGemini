# KHT バーコードスキャンシステム 技術仕様書

## 1. プロジェクト概要

本システムは、工場や倉庫における部品管理業務を効率化するための、PCカメラを利用したバーコードスキャンアプリケーション群である。主な目的は、バーコードをスキャンして「いつ」「どこで」「何を」スキャンしたかを記録し、そのデータを基に発注情報との照合や、部品情報の検索を容易にすることである。

システムは複数の独立したGUIツールで構成されており、`G_Launcher.py` を介して各機能にアクセスする。

## 2. システムアーキテクチャ

### 2.1. 基本ワークフロー

1.  **起動:** `G_Launcher.py` から「バーコードスキャン実行」を選択し、`G_ScanBCD_main.py` を起動する。
2.  **場所と工事番号の選択:** `G_ScanBCD_Location.py` の画面で、作業場所と対象の工事番号を選択する。
3.  **スキャン開始:** `G_ScanBCD_Scanner.py` がカメラを起動し、スキャン画面が表示される。
4.  **データ記録:** スキャンされたバーコードは `data/{工事番号}.csv` にUTF-8で追記される。
5.  **手動登録:** スキャン画面から `G_ManualEntryDialog.py` を呼び出し、発注伝票CSVを検索して手動でデータを登録できる。
6.  **終了と後処理:** スキャン終了後、`G_ScanBCD_FixCSV.py` が重複データをチェックし、`G_DrawingNumberViewer.py` などの後続ツールを任意で起動できる。

### 2.2. データフローとエンコード仕様

- **入力データ:**
    - **スキャンデータ (`data/{工事番号}.csv`):** `G_ScanBCD_main.py` が生成する、ヘッダーなしの生データ。`[バーコード情報, 工事番号, 場所, 種別, タイムスタンプ]` の形式。
    - **発注伝票データ (`Source/{工事番号}s.csv`):** 部品情報が記載されたマスターデータ。外部で用意される。
- **出力データ:**
    - **結合データ (`data/{工事番号}result.csv`):** `create_combined_csv.py` がスキャンデータと発注伝票データを結合して生成する、ヘッダー付きのCSVファイル。
- **エンコード:**
    - **本システムの入出力CSVファイルは、すべて `UTF-8` で統一されている。** Shift_JISなど、他のエンコードが必要な場合は、本システムの外部の後続処理で変換する必要がある。

## 3. コンポーネント（ファイル）解説

### 3.1. ランチャー

-   **`G_Launcher.py`**
    -   **役割:** 全てのツールへの入り口となるGUIランチャー。
    -   **単独起動:** 可能 (`python G_Launcher.py`)。

### 3.2. メインスキャン関連

-   **`G_ScanBCD_main.py`**: メインワークフローの制御役。単独起動可能。
-   **`G_ScanBCD_Scanner.py`**: カメラ制御とバーコードスキャンのコアエンジン。
-   **`G_ScanBCD_Location.py`**: 起動時の場所・工事番号選択GUI。
-   **`G_ScanBCD_CsvWriter.py`**: スキャンデータをCSVに追記する。
-   **`G_ScanBCD_DataCollector.py`**: スキャン情報を辞書形式に整形する。
-   **`G_ScanBCD_Overlay.py`**: カメラ映像に情報をリアルタイム描画する。
-   **`G_ScanBCD_Results.py`**: スキャン完了後の結果概要ダイアログ。
-   **`G_ManualEntryDialog.py`**: 手動登録用モーダルダイアログ。単体でのテスト起動も可能。

### 3.3. データ加工・照合ツール

-   **`G_ScanBCD_FixCSV.py`**: スキャンデータCSVの重複・不正データを修正する。単独起動可能。
-   **`G_DrawingNumberViewer.py`**: スキャンデータと発注伝票データを照合・監査するツール。単独起動可能。
-   **`G_PartInfoViewer.py`**: バーコードをキーに部品情報を検索する高機能ツール。カメラ機能、同一図番検索機能も内蔵。単独起動可能。
-   **`create_combined_csv.py`**: スキャンデータと発注データをマージし、最終的なレポートCSVを生成する。単独起動可能。

### 3.4. 設定・共通モジュール

-   **`config.json`**: システム全体の設定ファイル。カメラ設定、バーコード仕様、CSV列名などを定義。
-   **`G_config.py`**: `config.json` の読み書きを抽象化するクラス。
-   **`G_ScanBCD_Analyzer.py`**: `pyzbar` を用いて画像からバーコードを解析する。

## 4. コードレビューに基づく改善提案

(既存の `Code_Review_Summary.md` の内容を統合・反映)

-   **🔴 仕様確認済:** `G_ScanBCD_FixCSV.py` のバーコード英字チェックは、「数字のみ」という運用ルールに基づく意図した仕様である。

-   **🟡 中優先度（安定性）:**
    -   **「バーコードなし物品」IDの一意性:** `G_ScanBCD_Scanner.py` のID生成ロジックは、セッションをまたいだ一意性が保証されない。最後に使用した番号をファイルに保存・読み込みするなどの改善を推奨。
    -   **描画の二重実行:** `G_ScanBCD_Analyzer.py` と `G_ScanBCD_Overlay.py` でバーコードの矩形が二重に描画されている。描画処理は `G_ScanBCD_Overlay.py` に一元化すべき。

-   **🟢 低優先度（パフォーマンス・UI）:**
    -   **重複チェックの効率:** `G_ScanBCD_Scanner.py` 内でスキャン済みバーコードを記録する `list` を `set` に変更することで、パフォーマンス向上が見込める。
    -   **ウィンドウ位置の固定:** `G_ScanBCD_Scanner.py` でスキャナウィンドウの位置が固定値で計算されている。`tkinter`で画面サイズを動的に取得する方式に変更すれば、異なる解像度のPCでも安定して表示できる。
    -   **エンコードのハードコード:** 各所に `encoding='utf-8'` が直接記述されている。将来的にエンコードを変更する可能性に備え、`G_config.py` から設定値を読み込むように統一することも考えられる。（ただし、現行はUTF-8統一仕様）

## 5. 運用前点検チェックリスト

(既存の `Code_Review_Summary.md` の内容を統合・反映)

1.  **【最重要】運用ルールの再確認:** バーコードは「数字のみ」というルールを関係者全員で再確認する。
2.  **`config.json` の再確認:** `barcode_type`, `expected_length`, 各種CSV列名が、使用する実データと完全に一致しているかを確認する。
3.  **実行環境の準備:** `opencv-python`, `pyzbar`, `numpy` がインストールされているか確認する。
4.  **一連の操作テスト:**
    1.  `G_DrawingNumberViewer.py` でマスターCSV（発注伝票）を一度開き、設定を保存する。
    2.  `G_ScanBCD_main.py` を起動し、場所と工事番号を選択。
    3.  バーコードのスキャン、重複スキャン、手動登録(`m`キー)、バーコードなし登録(`n`キー) を試す。
    4.  `data` フォルダ内に正しい内容のCSVが `UTF-8` で生成されているか確認する。
5.  **照合・監査ツールのテスト:** `G_DrawingNumberViewer.py` で「照合実行」を行い、結果が意図通りか確認する。
6.  **CSV修正ツールのテスト:** `G_ScanBCD_FixCSV.py` を単独起動し、生成されたCSVの重複削除が機能するかテストする。
