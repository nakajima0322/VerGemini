# バーコードスキャナ アプリケーション コードレビュー報告書

## 1. アプリケーション全体の構造

このプロジェクトは、単一のアプリケーションではなく、連携して動作する
複数のGUIツール群で構成されています。

- **`G_ScanBCD_main.py`**:
  アプリケーション全体の流れを制御する起動スクリプト。
- **`G_ScanBCD_Location.py`**:
  最初に「保管場所」と「工事番号」をユーザーに選択させる画面。
- **`G_ScanBCD_Scanner.py`**:
  中核機能。カメラでバーコードを読み取り、CSVに保存します。
  手動登録機能も持ちます。
- **`G_ManualEntryDialog.py`**:
  スキャナから呼び出され、マスターCSV（発注伝票）を検索して
  手動登録するための画面。
- **`G_DrawingNumberViewer.py`**:
  スキャンしたデータとマスターCSVを照合・監査するための独立したツール。
  このツールがマスターCSVの場所を記憶することで、上記の手動登録機能が
  動作します。
- **`G_ScanBCD_FixCSV.py`**:
  出力されたCSVから重複や不正なデータを削除するための、
  後処理・メンテナンス用ツール。
- **その他支援モジュール**:
  `G_config.py` (設定管理), `G_ScanBCD_Analyzer.py` (画像解析),
  `G_ScanBCD_Overlay.py` (画面表示) など。

## 2. 総合評価

全体として、**非常によく設計され、実用的な機能が豊富に盛り込まれた
優れたアプリケーション**です。各機能がモジュールとして適切に分割されており、
見通しが良いです。また、前回入力値の記憶やキーボード操作への対応など、
利用者の使いやすさを考慮した工夫が随所に見られ、完成度が非常に高いです。

---

## 3. コード精査：重要な発見と改善提案

コード全体を精査した結果、特に重要と思われる点を優先度順に挙げます。

### 3.1. 🔴【確認済み】仕様に関する重要事項

- **ファイル**: `G_ScanBCD_FixCSV.py`
- **内容**:
  データ検証ロジックが、`CODE39`バーコードに英字が含まれている場合に
  「不正なデータ」として検出する。
- **結論**:
  これは、`CODE39`規格上は英字が使用可能であるものの、
  **本システムの運用ルールとして「バーコードは数字のみ」という
  制限を設けているため、意図された正しい仕様**です。
  このチェックは、データの一貫性を保つための重要な役割を果たしています。

### 3.2. 🟡 中優先度（機能の安定性・堅牢性）

- **ファイル**: `G_ScanBCD_Scanner.py`
  - **問題**:
    「バーコードなし物品」のID生成ロジックは、アプリを再起動すると
    過去に発行したIDを再度発行してしまう可能性があり、
    セッションをまたいだ一意性が保証されません。
  - **修正案**:
    より堅牢な採番ルールを検討してください。例えば、最後に使用した番号を
    別のファイルに保存・読み込みする、あるいは「プレフィックス + 日時」
    のような重複しにくいID形式を採用するなどです。

- **ファイル**: `G_ScanBCD_Analyzer.py` と `G_ScanBCD_Overlay.py`
  - **問題**:
    検出したバーコードを囲む四角形が、`Analyzer`と`Overlay`の両方で
    **二重に描画**されており、非効率です。
  - **修正案**:
    描画処理を`G_ScanBCD_Overlay.py`に一元化することをお勧めします。
    `Analyzer`は検出に専念させ、戻り値として画像そのものではなく、
    バーコードの位置情報を返すようにすると、役割分担がより明確になります。

### 3.3. 🟢 低優先度（使いやすさ・パフォーマンス向上）

- **ファイル**: `G_ScanBCD_Scanner.py`
  - **問題**:
    スキャン済みのバーコードを記録する`self.barcode_data`が`list`型です。
    スキャン件数が数千件を超えると、重複チェックのパフォーマンスが
    低下する可能性があります。
  - **修正案**:
    `self.barcode_data`を`set`型に変更すると、検索速度が大幅に向上します。
    （`append`を`add`に変更）

- **ファイル**: `G_ScanBCD_Scanner.py`
  - **問題**:
    スキャナウィンドウの位置を決めるための画面幅が`1366`で固定されています。
    解像度の違うPCでは表示が崩れる可能性があります。
  - **修正案**:
    `tkinter`を使って画面サイズを動的に取得する処理を入れると、
    どんな環境でも安定して表示できます。

---

## 4. 運用前点検チェックリスト

このアプリケーションを実際に運用する前に、以下の点検を行うことを
強く推奨します。

1.  **【最重要】運用ルールの再確認**:
    - `G_ScanBCD_FixCSV.py`の英字チェックは意図した仕様であることを確認済。
      今後、もし英字を含むバーコードを扱う可能性がある場合は、
      この仕様の変更が必要になることを留意してください。

2.  **`config.json` の再確認**:
    - 設定ファイルの内容を一行ずつ確認してください。
    - 特に `barcode_type`と `expected_length`が、実際にスキャンする
      バーコードの仕様と完全に一致しているかを確認します。
    - `source_csv_order_no_column` などのCSV列名が、
      使用するファイルと一致しているかを確認します。

3.  **実行環境の準備**:
    - Pythonの実行環境に、必要なライブラリ（`opencv-python`, `pyzbar`,
      `numpy`）がすべてインストールされていることを確認してください。
    - `data`フォルダと`Source`フォルダが正しく配置されていることを
      確認してください。

4.  **一連の操作テスト（ユーザートレーニング）**:
    - 利用者の操作フローに従って、一通りのテストを実行します。
        1. 最初に `G_DrawingNumberViewer.py` を起動し、「工事番号」を
           入力後、「参照...」からマスターとなる**発注伝票CSV**を選択します。
           一度ツールを閉じ、設定が保存されることを確認します。
        2. `G_ScanBCD_main.py` を起動します。
        3. 場所選択画面で、場所と工事番号を選択します。
        4. スキャナ画面で、いくつかのバーコードをスキャンします。
        5. 同じバーコードを再度スキャンし、「Duplicates」の数が増えることを
           確認します。
        6. `m`キーを押し、図番検索から手動登録を試します。
        7. `n`キーを押し、バーコードなし物品の登録を試します。
        8. `q`キーでスキャナを終了します。
        9. `data`フォルダ内に`{工事番号}.csv`が生成され、
           スキャン・登録したデータが正しく記録されているか確認します。

5.  **照合・監査ツールのテスト**:
    - 上記のテスト後、再度 `G_DrawingNumberViewer.py` を起動します。
    - 同じ工事番号を入力し、「照合実行」ボタンを押します。
    - 結果のテーブルに表示される「状態」が意図通りか、
      予期せぬ「該当なし」がないかを確認します。

6.  **CSV修正ツールのテスト**:
    - `G_ScanBCD_FixCSV.py` を単体で起動します。
    - ファイル選択ダイアログで、先ほど生成されたCSVファイルを選びます。
    - 重複データがあれば、削除確認画面が表示されることを確認し、
      実際に削除が機能するかをテストします。
